---
name: brew pr-pull

on:
  pull_request_target:
    types:
      - labeled

jobs:
  pr-pull:
    if: contains(github.event.pull_request.labels.*.name, 'pr-pull')
    runs-on: ubuntu-22.04
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      packages: write
      pull-requests: write
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GH_BOT_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: '⚠️ **Important**: This PR is being processed to add bottles. Please do not push any changes to this PR branch as it may cause conflicts or issues with the bottle publishing process. If you need to make changes, please close this PR and open a new one.'
            });

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          stable: true
          token: ${{ secrets.GH_BOT_TOKEN }}

      - name: Set up git
        run: |
          git config user.name "${{ secrets.GH_BOT_NAME }}"
          git config user.email "${{ secrets.GH_BOT_EMAIL }}"

      - name: Checkout PR branch
        env:
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          PR_FROM_FORK: ${{ github.event.pull_request.head.repo.fork }}
        run: |
          cd "$(brew --repository)/Library/Taps/${GITHUB_REPOSITORY/\//-}"

          # Fetch the PR branch
          if [ "$PR_FROM_FORK" = "true" ]; then
            git fetch "https://github.com/${PR_HEAD_REPO}.git" "${PR_HEAD_REF}:${PR_HEAD_REF}"
          else
            git fetch origin "${PR_HEAD_REF}:${PR_HEAD_REF}"
          fi

          # Checkout the PR branch
          git checkout "${PR_HEAD_REF}"

      - name: Pull bottles
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_BOT_TOKEN }}
          HOMEBREW_GITHUB_PACKAGES_TOKEN: ${{ secrets.GH_BOT_TOKEN }}
          HOMEBREW_GITHUB_PACKAGES_USER: ${{ github.repository_owner }}
          PULL_REQUEST: ${{ github.event.pull_request.number }}
        run: brew pr-pull --debug --workflows --tap="${GITHUB_REPOSITORY}" "${PULL_REQUEST}"

      - name: Push commits to PR branch
        env:
          GITHUB_TOKEN: ${{ secrets.GH_BOT_TOKEN }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
          PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          PR_FROM_FORK: ${{ github.event.pull_request.head.repo.fork }}
        run: |
          cd "$(brew --repository)/Library/Taps/${GITHUB_REPOSITORY/\//-}"

          # Check if there are any changes to commit
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to push"
            exit 0
          fi

          # Configure git to use the token for authentication
          git config url."https://x-access-token:${GITHUB_TOKEN}@github.com/".insteadOf "https://github.com/"

          # Push to the PR branch
          if [ "$PR_FROM_FORK" = "true" ]; then
            # For forks, push to the fork repository
            git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${PR_HEAD_REPO}.git" "HEAD:${PR_HEAD_REF}"
          else
            # For origin PRs, push to origin
            git push origin "HEAD:${PR_HEAD_REF}"
          fi
